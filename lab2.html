
CREATE database SALESDETAIL;
USE SALESDETAIL;

CREATE TABLE SALESMAN(
SALESMAN_ID varchar(8),
NAME varchar(20),
CITY varchar(20),
COMMISSION varchar(10),
CONSTRAINT PKS primary key(SALESMAN_ID)

);

create TABLE CUSTOMER(
CUSTOMER_ID varchar(8),
CUST_NAME varchar(20),
CITY varchar(20),
GRADE integer,
SALESMAN_ID varchar(8),
constraint PKC primary key(CUSTOMER_ID),
constraint FKC foreign key(SALESMAN_ID) REFERENCES SALESMAN(SALESMAN_ID) ON delete SET NULL
);

create TABLE ORDERS(
ORD_ID VARCHAR(8),
PURCHASE_AMT INTEGER,
ORD_DATE DATE,
CUSTOMER_ID varchar(8),
SALESMAN_ID varchar(8),
constraint PKO primary key(ORD_ID),
constraint FKOI foreign key(CUSTOMER_ID) REFERENCES CUSTOMER(CUSTOMER_ID) ON delete cascade,
constraint FKO foreign key(SALESMAN_ID) REFERENCES SALESMAN(SALESMAN_ID) ON delete cascade
);

insert INTO SALESMAN values('S1','SUMA','BLR','20%');
insert INTO SALESMAN values('S2','PUJA','BLR','25%');
insert INTO SALESMAN values('S3','RAVI','DEL','10%');
insert INTO SALESMAN values('S4','ANUJ','BIR','20%');
insert INTO SALESMAN values('S5','ANU','CHI','40%');
SELECT * FROM SALESMAN;
insert INTO CUSTOMER values('C1','APARNA','BLR',200,'S1');
insert INTO CUSTOMER values('C2','ARUN','BIR',300,'S1');
insert INTO CUSTOMER values('C3','ADITIYA','CHI',400,'S2');
insert INTO CUSTOMER values('C4','BINDHU','BLR',200,'S2');
insert INTO CUSTOMER values('C5','ISHANI','BLR',400,'S3');

insert INTO ORDERS values('01',5000,'2017-03-04','C1','S1');
insert INTO ORDERS values('02',6000,'2017-03-04','C1','S1');
insert INTO ORDERS values('03',8000,'2017-03-04','C2','S1');
insert INTO ORDERS values('04',5000,'2017-04-07','C5','S2');
insert INTO ORDERS values('05',9000,'2017-04-07','C3','S3');
insert INTO ORDERS values('06',500,'2017-04-06','C4','S1');
SELECT * FROM ORDERS;

SELECT GRADE,count(DISTINCT CUSTOMER_ID) AS NO_OF_CUSTOMER
FROM CUSTOMER
group by GRADE
HAVING GRADE>(select avg(GRADE) FROM CUSTOMER WHERE CITY='BLR');

select SALESMAN_ID,NAME 
FROM SALESMAN S where ((select count(*) FROM CUSTOMER WHERE SALESMAN_ID=S.SALESMAN_ID)>1);

select S.SALESMAN_ID,S.CITY
FROM SALESMAN S
where exists(select CITY FROM CUSTOMER where S.CITY=CITY AND S.SALESMAN_ID=SALESMAN_ID)
union
select S.SALESMAN_ID,'NO_MATCH'
FROM SALESMAN S
where NOT exists(select CITY FROM CUSTOMER where S.CITY=CITY AND S.SALESMAN_ID=SALESMAN_ID);

create VIEW BC AS 
select S.SALESMAN_ID,S.ORD_DATE
FROM ORDERS S 
where (select SUM(PURCHASE_AMT) FROM ORDERS where S.ORD_DATE=ORD_DATE AND S.SALESMAN_ID=SALESMAN_ID AND S.CUSTOMER_ID=CUSTOMER_ID)=
(select MAX(sum(PURCHASE_AMT)) FROM ORDERS S1 where S.ORD_DATE=S1.ORD_DATE
 group by S1.ORD_DATE,S1.CUSTOMER_ID,S1.SALESMAN_ID);
 
 CREATE VIEW BC AS 
SELECT S.SALESMAN_ID, S.ORD_DATE
FROM ORDERS S
WHERE (SELECT SUM(PURCHASE_AMT) 
       FROM ORDERS 
       WHERE S.ORD_DATE = ORD_DATE 
         AND S.SALESMAN_ID = SALESMAN_ID 
         AND S.CUSTOMER_ID = CUSTOMER_ID
       GROUP BY ORD_DATE, CUSTOMER_ID, SALESMAN_ID) =
      (SELECT MAX(total_purchase)
       FROM (SELECT SUM(PURCHASE_AMT) AS total_purchase
             FROM ORDERS S1
             WHERE S.ORD_DATE = S1.ORD_DATE
             GROUP BY S1.ORD_DATE, S1.CUSTOMER_ID, S1.SALESMAN_ID) AS max_purchase);
select *from bc; 
delete from SALESMAN WHERE SALESMAN_ID='S1';
select *FROM CUSTOMER;
select *FROM ORDERS;
